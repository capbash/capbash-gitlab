#!/bin/bash
source ./bits/bootstrap/logging

#-----------
# Configurations
#-----------

LAUNCHER_OWNER=${LAUNCHER_OWNER-$USER}

export LAUNCHER_DIR=${LAUNCHER_DIR-/var/local}
export GITLAB_LAUNCHER_DIR=${GITLAB_LAUNCHER_DIR-$LAUNCHER_DIR/gitlab}
export GITLAB_HTTP_PORT=${GITLAB_HTTP_PORT-80}
export GITLAB_VERSION=${GITLAB_VERSION-7.9.4}
export GITLAB_URL=${GITLAB_URL-localhost}
export GITLAB_SSL_URL=${GITLAB_SSL_URL-localhost}
export GITLAB_CI_URL=${GITLAB_CI_URL-localhost}
export DATA_DIR=${DATA_DIR-/var/local/data}
export GITLAB_DATA_DIR=${GITLAB_DATA_DIR-$DATA_DIR/gitlab}
export GITLAB_PORT=${GITLAB_PORT-10080}
export GITLAB_SSH_PORT=${GITLAB_SSH_PORT-10022}
export GITLAB_CI_PORT=${GITLAB_CI_PORT-11080}

export GITLAB_DB_USER=${GITLAB_DB_USER-$POSTGRES_ADMIN_USERNAME}
export GITLAB_DB_PASSWORD=${GITLAB_DB_PASSWORD-$POSTGRES_ADMIN_PASSWORD}

export GITLAB_CI_DATA_DIR=${GITLAB_CI_DATA_DIR-$DATA_DIR/gitlab_ci}

export GITLAB_APP_ID=${GITLAB_APP_ID-}
export GITLAB_APP_SECRET=${GITLAB_APP_SECRET-}

export GITLAB_VERSION=${GITLAB_VERSION-latest}
export GITLAB_CI_VERSION=${GITLAB_CI_VERSION-$GITLAB_VERSION}

GITLAB_OUTPUT=/tmp/gitlab-install.log

#-----------
# Install Script
#-----------

notify "Installing gitlab app ..."

OWNER=$LAUNCHER_OWNER DIR=$GITLAB_LAUNCHER_DIR/src NAME=gitlab URL=$GITLAB_SSL_URL \
  ./bits/gitlab/gencert
[ $? -ne 0 ] && exit 1

OWNER=$LAUNCHER_OWNER ./bits/bootstrap/mkdir GITLAB_LAUNCHER_DIR GITLAB_DATA_DIR $GITLAB_LAUNCHER_DIR/src
NAME=gitlab VERSION=$GITLAB_VERSION IMAGE_NAME=sameersbn/gitlab:$GITLAB_VERSION \
  DIR=$GITLAB_LAUNCHER_DIR BIT=gitlab ./bits/docker/helpers

OWNER=$LAUNCHER_OWNER \
  TEMPLATE=./bits/gitlab/files/helpers \
  LOCATION=$GITLAB_LAUNCHER_DIR \
  ./bits/docker/copyallif \
  @GITLAB_PORT@ $GITLAB_PORT \
  @GITLAB_SSH_PORT@ $GITLAB_SSH_PORT \
  @GITLAB_SSH_PORT@ $GITLAB_SSH_PORT \
  @GITLAB_DATA_DIR@ $GITLAB_DATA_DIR \
  @GITLAB_DB_USER@ $GITLAB_DB_USER \
  @GITLAB_DB_PASSWORD@ $GITLAB_DB_PASSWORD \
  @GITLAB_CI_PORT@ $GITLAB_CI_PORT \
  @GITLAB_CI_DATA_DIR@ $GITLAB_CI_DATA_DIR \
  @GITLAB_LAUNCHER_DIR@ $GITLAB_LAUNCHER_DIR \
  @GITLAB_URL@ $GITLAB_URL \
  @GITLAB_CI_URL@ $GITLAB_CI_URL \
  @GITLAB_APP_ID@ $GITLAB_APP_ID \
  @GITLAB_APP_SECRET@ $GITLAB_APP_SECRET \
  @GITLAB_VERSION@ $GITLAB_VERSION \
  @GITLAB_CI_VERSION@ $GITLAB_CI_VERSION

$POSTGRES_LAUNCHER_DIR/newdb gitlab $GITLAB_DB_USER $GITLAB_DB_PASSWORD
$POSTGRES_LAUNCHER_DIR/newdb gitlab_ci $GITLAB_DB_USER $GITLAB_DB_PASSWORD

notify "DONE, Installing gitlab app."